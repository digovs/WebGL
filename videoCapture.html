<html>

<head>
<title>MATA65 - Computação Gráfica</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<script id="shader-vs" type="x-shader/x-vertex">
	attribute vec3 aVertexPosition;
	attribute vec2 aVertexTexture;
		
	varying vec2 vTextureCoord;

	void main(void) {
		gl_Position = vec4(aVertexPosition, 1.0);
		vTextureCoord = aVertexTexture;
	}
</script>

<script id="shader-fs" type="x-shader/x-fragment">
	precision mediump float;
		
	uniform sampler2D uSampler;
	uniform vec2 vTextureSize;

	uniform float kernel[9];
	
	varying vec2 vTextureCoord;

	uniform float radiusValue;
    uniform float strengthValue;
    uniform vec2 centerVector;

	// function IDs
	uniform float brightValue;
	uniform float contrastValue;
	uniform float saturationValue;

	uniform int warholSelected;
	uniform int warholColors;

	void main(void) {
		vec4 color = texture2D(uSampler, vTextureCoord);

		// Questão 2- Transformação: Uma bolha de zoom in ou zoom out
		// usuário pode escolher tamanho da bolha, posição e intensidade
		// essa TEM QUE ser a primeira alteração, pois ela é a base para
		// as outras. 
		vec2 coord = vTextureCoord*vTextureSize;
		coord -= centerVector;
        float distance = length(coord);
        if (distance < radiusValue) {
            float percent = distance / radiusValue;
            if (strengthValue > 0.0) {
                coord *= mix(1.0, smoothstep(0.0, radiusValue / distance, percent), strengthValue * 0.75);
            } else {
                coord *= mix(1.0, pow(percent, 1.0 + strengthValue * 0.75) * radiusValue / distance, 1.0 - percent);
            }
        }
        coord += centerVector;

        coord = coord/vTextureSize;
        color = vec4(texture2D(uSampler, coord));


        // apply unsharpen mask to have better distinctness
		vec2 onePixel = coord / vTextureSize;
	    vec4 cSum =
	     texture2D(uSampler, coord + onePixel * vec2(-1, -1)) * kernel[0] +
	     texture2D(uSampler, coord + onePixel * vec2( 0, -1)) * kernel[1] +
	     texture2D(uSampler, coord + onePixel * vec2( 1, -1)) * kernel[2] +
	     texture2D(uSampler, coord + onePixel * vec2(-1,  0)) * kernel[3] +
	     texture2D(uSampler, coord + onePixel * vec2( 0,  0)) * kernel[4] +
	     texture2D(uSampler, coord + onePixel * vec2( 1,  0)) * kernel[5] +
	     texture2D(uSampler, coord + onePixel * vec2(-1,  1)) * kernel[6] +
	     texture2D(uSampler, coord + onePixel * vec2( 0,  1)) * kernel[7] +
	     texture2D(uSampler, coord + onePixel * vec2( 1,  1)) * kernel[8] ;

	    float kernelWeight =
	     kernel[0] +
	     kernel[1] +
	     kernel[2] +
	     kernel[3] +
	     kernel[4] +
	     kernel[5] +
	     kernel[6] +
	     kernel[7] +
	     kernel[8] ;

	    if (kernelWeight <= 0.0) {
	      kernelWeight = 1.0;
	    }

	    color = vec4((cSum / kernelWeight).rgb, 1.0);

	    // apply brightness
		color.rgb += brightValue;

		// apply contrast
		if (contrastValue > 0.0) {  
		    color.rgb = (color.rgb - 0.5) / (1.0 - contrastValue) + 0.5;
        } else if (contrastValue < 0.0) {
            color.rgb = (color.rgb - 0.5) * (1.0 + contrastValue) + 0.5;
        }

		// apply saturation
        float average = (color.r + color.g + color.b) / 3.0;
        if (saturationValue > 0.0) {
            color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturationValue));
        } else if (saturationValue < 0.0){
            color.rgb += (average - color.rgb) * (-saturationValue);
        }

        // change warhol colors
        if (warholSelected == 1) {
			if (warholColors == 0)
				color.rgb = color.gbr;
			else if (warholColors == 1)
				color.rgb = color.rbg;
			else if (warholColors == 2)
				color.rgb = color.grb;
			else
				color.rgb = color.bgr;
        }

	    gl_FragColor = color;

	}
</script>

<script type="text/javascript" src="lib/webgl-utils.js"></script>
<script type="text/javascript" src="lib/shaders.js"></script>
<script type="text/javascript" src="videoCapture.js"></script>

</head>

<body onload="webGLStart();" style="width:800px; height:500px">
    <h1>Trabalho</h1><br />
    <p>Captura e manipulação de video em WebGL.</p>
    <br/>
    <div class="controllers">
    	<div class="cBright" style="float:left">
    		<div id="brightOutput">Bright Value = 0 </div>
	    	<input type="range" id="brightValue" min="-1.0" max="1.0" step="0.05" value="0" onchange="changeBright(this.value)" oninput="changeBright(this.value)">
    	</div>
	    
	    <div class="cContrast" style="float:left">
		    <div id="contrastOutput">Contrast Value = 0 </div>
		    <input type="range" id="contrastValue" min="-1" max="1" step="0.1" value="0" onchange="changeContrast(this.value)" oninput="changeContrast(this.value)">
		</div>

		<div class="cSaturation" style="float:left">
		    <div id="saturationOutput">Saturation Value = 0 </div>
		    <input type="range" id="saturationValue" min="-1" max="1" step="0.05" value="0" onchange="changeSaturation(this.value)" oninput="changeSaturation(this.value)">
		</div>
	    
		<div class="cSharpen" style="float:left">
			<div id="sharpenOutput">Sharpen Value = 0 </div>
	    	<input type="range" id="sharpenValue" min="4.1" max="5" step="0.005" value="8" onchange="changeSharpen(this.value)" oninput="changeSharpen(this.value)">
		</div>

		<div class="cStrength">
			<div id="strengthOutput">Strength Value = 0</div>
			<input type="range" id="strengthValue" min="-1" max="1" step="0.002" value="0" oninput="changeStrength(this.value)">
		</div>

		<div class="cRadius">
			<div id="radiusOutput">Radius Value = 0</div>
			<input type="range" id="radiusValue" min="0" max="100" step="0.1" value="0" oninput="changeRadius(this.value)">
		</div>

		<div class="cCenterX">
			<div id="centerXOutput">CenterX Value = 0</div>
			<input type="range" id="centerXValue" min="0" max="360" step="0.1" value="0" oninput="changeCenterX(this.value)">
		</div>

		<div class="cCenterY">
			<div id="centerYOutput">CenterY Value = 0</div>
			<input type="range" id="centerYValue" min="0" max="240" step="0.1" value="0" oninput="changeCenterY(this.value)">
		</div>

		<div>
			<input type="button" id="warholButton" value="Apply Warhol" onClick="checkWarhol()">
		</div>

		<div class="resetButton">
			<input type="button" value="Reset" onclick="reset()">
		</div>

	    
	</div>
	<div class="videoContainer" style="float:left">
		<canvas id="videoGL" width="320" height="240" style="visibility: visible;"></canvas>
		<video id="monitor" autoplay width="320" height="240" style="visibility: visible;"></video>
		<canvas id="videoImage" width="256" height="256" style="visibility: hidden;"></canvas>
	</div>
	
</body>

</html>
